<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathfinder - JS Path (Level 5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #115e59, #0f766e, #0d9488, #0e7490);
            background-size: 400% 400%;
            animation: gradientBG 25s ease infinite;
            color: #d1d5db;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .card {
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            background: rgba(15, 23, 42, 0.7);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid rgba(45, 212, 191, 0.3);
            background: rgba(45, 212, 191, 0.1);
            color: #5eead4;
        }
        .btn:hover, .btn:focus {
            background: rgba(45, 212, 191, 0.2);
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.3);
        }
        h1, h2, h3, h4 {
            color: white;
        }
        [data-screen] { display: none; }
        [data-screen].active { display: block; }

        /* Drag and Drop Styles */
        .drag-item { cursor: grab; user-select: none; background-color: rgba(255, 255, 255, 0.1); color: white; }
        .drop-target { border: 2px dashed rgba(255, 255, 255, 0.3); transition: background-color 0.2s ease; }
        .drop-target.drag-over { background-color: rgba(255, 255, 255, 0.1); border-color: #2dd4bf; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes xp-animation {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.1); opacity: 0; }
        }
        .xp-popup {
            position: absolute;
            top: 2rem;
            right: 2rem;
            padding: 4px 12px;
            background-color: #2dd4bf;
            color: white;
            border-radius: 9999px;
            font-weight: bold;
            animation: xp-animation 1.5s ease-out forwards;
            z-index: 100;
            pointer-events: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        /* Flash Question Styles */
        @keyframes pulse { 50% { opacity: .7; } }
        .flash-indicator { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Custom input style for the new theme */
        .themed-input {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-family: monospace;
        }
        .themed-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.5);
            border-color: #2dd4bf;
        }
        .themed-input::placeholder {
            color: #9ca3af;
        }
        
        /* Achievement Tooltip Styles */
        .achievement-icon {
            position: relative;
            cursor: pointer;
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            z-index: 10;
            transition: opacity 0.3s;
            width: 200px;
            font-size: 0.875rem;
            pointer-events: none;
        }
        .achievement-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-title {
            font-weight: bold;
            display: block;
        }
        .tooltip-desc {
            font-size: 0.75rem;
            display: block;
            margin-top: 4px;
            color: #ccc;
        }

        /* Sidebar, Modal, and other UI component styles FROM INDEX.HTML */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            z-index: 100;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        #overlay {
            transition: opacity 0.3s ease-in-out;
            z-index: 90;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 110;
        }
        .modal-content {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .themed-input {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        .themed-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.5);
            border-color: #2dd4bf;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Sidebar and Auth Modals Wrapper FROM INDEX.HTML -->
    <div>
        <!-- Hover zone to activate sidebar -->
        <div id="sidebar-hover-zone" class="fixed top-0 left-0 h-full z-50" style="width: 100px;"></div>

        <!-- Slide-out Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-gradient-to-b from-gray-900 to-slate-800 border-r border-gray-700/50 shadow-2xl p-6 flex flex-col">
            <!-- Header -->
            <div class="flex items-center gap-3 mb-8">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-teal-400">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    <line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h1 class="text-2xl font-bold text-white">Pathfinder</h1>
            </div>

            <!-- Level Navigation -->
            <nav class="flex-grow">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Levels</h2>
                <ul class="space-y-2">
                    <li><a href="index1.html" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-colors"><i data-lucide="flag" class="w-5 h-5 text-gray-400"></i> Level 1: Functions</a></li>
                    <li><a href="index2.html" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-colors"><i data-lucide="list" class="w-5 h-5 text-gray-400"></i> Level 2: Arrays</a></li>
                    <li><a href="index3.html" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-colors"><i data-lucide="git-fork" class="w-5 h-5 text-gray-400"></i> Level 3: Loops</a></li>
                    <li><a href="index4.html" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-colors"><i data-lucide="infinity" class="w-5 h-5 text-gray-400"></i> Level 4: Recursion</a></li>
                    <li><a href="index5.html" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-colors"><i data-lucide="box" class="w-5 h-5 text-gray-400"></i> Level 5: OOP</a></li>
                    <li><a href="index6.html" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-colors"><i data-lucide="database" class="w-5 h-5 text-gray-400"></i> Level 6: Data</a></li>
                    <li><a href="index7.html" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition-colors"><i data-lucide="trophy" class="w-5 h-5 text-gray-400"></i> Level 7: Finale</a></li>
                </ul>
            </nav>

            <!-- User/Auth Section -->
            <div id="auth-section">
                <!-- This button will be dynamically updated -->
                 <div id="auth-button-container">
                    <!-- Logged Out State -->
                    <button id="login-register-btn" class="w-full flex items-center justify-center gap-2 p-2 rounded-lg bg-teal-600 hover:bg-teal-500 transition-colors text-white font-semibold">
                        <i data-lucide="log-in" class="w-5 h-5"></i>
                        <span>Login / Register</span>
                    </button>

                    <!-- Logged In State (template, hidden initially) -->
                    <div id="user-profile-btn" class="hidden w-full flex items-center justify-between p-2 rounded-lg bg-gray-800 text-white font-semibold">
                        <span id="user-display-name" class="truncate flex-grow mr-2"></span>
                        <div class="flex items-center gap-3">
                             <a href="index.html" title="Home" class="text-gray-400 hover:text-white transition-colors">
                                <i data-lucide="home" class="w-5 h-5"></i>
                            </a>
                            <i id="logout-icon" data-lucide="log-out" class="w-5 h-5 text-gray-400 hover:text-red-500 transition-colors cursor-pointer" title="Logout"></i>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Overlay for when sidebar is open -->
        <div id="overlay" class="fixed inset-0 bg-black opacity-0 pointer-events-none"></div>

        <!-- Modals -->
        <div id="auth-modal" class="modal fixed inset-0 flex items-center justify-center p-4 opacity-0 pointer-events-none">
            <div class="modal-content rounded-2xl shadow-xl w-full max-w-md p-8" id="auth-modal-content">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">

        <!-- Screen 1: Welcome (Level 5) -->
        <div data-screen="welcome" class="w-full max-w-lg text-center active">
            <div class="card fade-in">
                <div class="flex justify-center mb-4">
                     <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-teal-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9V15M9 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <h1 class="text-4xl font-bold mb-2">Welcome to Level 5</h1>
                <p class="text-lg mb-8 text-gray-300">Organize and structure your code with JavaScript's Object-Oriented Programming principles.</p>
                <button id="start-learning-btn" class="btn text-lg">Begin Level 5</button>
            </div>
        </div>
        
        <!-- Screen 2: Learning Dashboard -->
        <div data-screen="dashboard" class="w-full max-w-6xl">
            <div class="p-4 md:p-8">
                
                <!-- NEW TOP NAV BAR -->
                <div id="top-nav" class="card !p-4 mb-8">
                    <!-- Header content and achievements will be injected here by JS -->
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <div class="card" id="activity-container">
                             <!-- Activity will be injected here -->
                        </div>
                    </div>
                    <div class="lg:col-span-1 space-y-8">
                        <div class="card sticky top-8">
                           <h3 class="text-lg font-bold mb-4">Your Journey (Lvl 5)</h3>
                           <div id="progress-tracker" class="space-y-3">
                               <!-- Progress items will be injected here -->
                           </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Achievement Modal -->
    <div id="achievement-modal" class="modal-overlay">
        <div class="modal-content card text-center max-w-sm w-full">
            <div id="modal-content-inner"></div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS & FIREBASE SETUP (from index.html) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, browserSessionPersistence, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA76y2Cp0jvLBNiMkkl4Mlklw4SKdBg_Wo",
            authDomain: "pathfinderquiz.firebaseapp.com",
            projectId: "pathfinderquiz",
            storageBucket: "pathfinderquiz.firebasestorage.app",
            messagingSenderId: "653607161175",
            appId: "1:653607161175:web:4ffd5922d221f26377c212",
            measurementId: "G-S7XJTZ1VTZ"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const googleProvider = new GoogleAuthProvider();
        let currentUser = null;

        // --- SHARED UI LOGIC (Sidebar, Modals from index.html) ---
        lucide.createIcons();
        
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const sidebarHoverZone = document.getElementById('sidebar-hover-zone');
        const authModal = document.getElementById('auth-modal');
        const authModalContent = document.getElementById('auth-modal-content');

        const openSidebar = () => {
            sidebar.classList.add('open');
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            overlay.classList.add('opacity-50');
        };

        const closeSidebar = () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('opacity-50');
            overlay.classList.add('opacity-0', 'pointer-events-none');
        };

        sidebarHoverZone.addEventListener('mouseenter', openSidebar);
        sidebar.addEventListener('mouseleave', closeSidebar);
        overlay.addEventListener('click', closeSidebar);

        const showModal = (content) => {
            authModalContent.innerHTML = content;
            authModal.classList.remove('opacity-0', 'pointer-events-none');
            attachModalEventListeners();
            lucide.createIcons();
        };
        
        const hideModals = () => {
            authModal.classList.add('opacity-0', 'pointer-events-none');
        };

        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) hideModals();
        });
        
        // --- AUTHENTICATION & DATABASE LOGIC (from index.html) ---
        const loginRegisterBtn = document.getElementById('login-register-btn');
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userDisplayName = document.getElementById('user-display-name');
        const logoutIcon = document.getElementById('logout-icon');

        const loginContent = `
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Login to Pathfinder</h2>
            <div class="space-y-3">
                <button id="google-signin-btn" class="w-full flex items-center justify-center gap-2 p-3 rounded-lg bg-white text-gray-800 font-semibold hover:bg-gray-200 transition-colors">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039L38.802 8.922C34.983 5.549 29.818 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691c-1.645 3.12-2.306 6.643-2.306 10.163C4 28.024 4.883 31.258 6.45 34.019l5.657-4.42C10.43 28.435 10 26.313 10 24c0-2.636 0.516-5.144 1.409-7.412l-5.103-3.897z"></path><path fill="#4CAF50" d="M24 48c5.166 0 9.86-1.977 13.409-5.192l-6.19-4.832C29.18 40.093 26.685 42 24 42c-4.482 0-8.3-2.922-9.829-6.965l-6.326 4.909C10.12 43.435 16.49 48 24 48z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-0.792 2.237-2.231 4.16-4.082 5.571l6.328 4.91c3.437-3.22 5.756-7.65 5.756-12.481c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                    Sign in with Google
                </button>
                <button id="guest-signin-btn" class="w-full p-3 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">Continue as Guest</button>
            </div>
            <div class="my-4 flex items-center justify-center">
                <span class="h-px bg-gray-600 flex-grow"></span>
                <span class="px-2 text-sm text-gray-400">OR</span>
                <span class="h-px bg-gray-600 flex-grow"></span>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-300">Email Address</label>
                    <input type="email" id="login-email" class="themed-input mt-1 block w-full rounded-md p-2" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                    <input type="password" id="login-password" class="themed-input mt-1 block w-full rounded-md p-2" required>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center"><input id="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-500 text-teal-600 focus:ring-teal-500"><label for="remember-me" class="ml-2 block text-gray-300">Remember me</label></div>
                    <a href="#" id="forgot-password-link" class="font-medium text-teal-400 hover:text-teal-300">Forgot password?</a>
                </div>
                <button type="submit" class="w-full p-3 mt-4 rounded-lg bg-teal-600 hover:bg-teal-500 text-white font-semibold transition-colors">Sign In</button>
            </form>
            <p class="text-center text-sm text-gray-400 mt-4">
                Don't have an account? <a href="#" id="show-register-link" class="font-medium text-teal-400 hover:text-teal-300">Register</a>
            </p>
        `;

        const registerContent = `
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Create an Account</h2>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-300">Email Address</label>
                    <input type="email" id="register-email" class="themed-input mt-1 block w-full rounded-md p-2" required>
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-300">Password</label>
                    <input type="password" id="register-password" class="themed-input mt-1 block w-full rounded-md p-2" required>
                </div>
                 <div>
                    <label for="register-confirm-password" class="block text-sm font-medium text-gray-300">Confirm Password</label>
                    <input type="password" id="register-confirm-password" class="themed-input mt-1 block w-full rounded-md p-2" required>
                </div>
                <button type="submit" class="w-full p-3 mt-4 rounded-lg bg-teal-600 hover:bg-teal-500 text-white font-semibold transition-colors">Create Account</button>
            </form>
             <p class="text-center text-sm text-gray-400 mt-4">
                Already have an account? <a href="#" id="show-login-link" class="font-medium text-teal-400 hover:text-teal-300">Login</a>
            </p>
        `;

        const forgotPasswordContent = `
            <h2 class="text-2xl font-bold text-white mb-4 text-center">Reset Password</h2>
            <p class="text-center text-sm text-gray-400 mb-6">Enter your email and we'll send you a link to reset your password.</p>
            <form id="forgot-password-form" class="space-y-4">
                <div>
                    <label for="forgot-email" class="block text-sm font-medium text-gray-300">Email Address</label>
                    <input type="email" id="forgot-email" class="themed-input mt-1 block w-full rounded-md p-2" required>
                </div>
                <button type="submit" class="w-full p-3 mt-4 rounded-lg bg-teal-600 hover:bg-teal-500 text-white font-semibold transition-colors">Send Reset Link</button>
            </form>
             <p class="text-center text-sm text-gray-400 mt-4">
                <a href="#" id="back-to-login-link" class="font-medium text-teal-400 hover:text-teal-300">Back to Login</a>
            </p>
        `;

        function attachModalEventListeners() {
            const showRegisterLink = document.getElementById('show-register-link');
            if(showRegisterLink) showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showModal(registerContent); });
            const showLoginLink = document.getElementById('show-login-link');
            if(showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showModal(loginContent); });
            const backToLoginLink = document.getElementById('back-to-login-link');
            if(backToLoginLink) backToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showModal(loginContent); });
            const registerForm = document.getElementById('register-form');
            if(registerForm) registerForm.addEventListener('submit', handleRegister);
            const loginForm = document.getElementById('login-form');
            if(loginForm) loginForm.addEventListener('submit', handleLogin);
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            if(forgotPasswordLink) forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showModal(forgotPasswordContent); });
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            if(forgotPasswordForm) forgotPasswordForm.addEventListener('submit', handleForgotPassword);
            const googleSigninBtn = document.getElementById('google-signin-btn');
            if(googleSigninBtn) googleSigninBtn.addEventListener('click', handleGoogleSignIn);
            const guestSigninBtn = document.getElementById('guest-signin-btn');
            if(guestSigninBtn) guestSigninBtn.addEventListener('click', handleGuestSignIn);
        }

        async function handleRegister(e) { e.preventDefault(); const email = document.getElementById('register-email').value, password = document.getElementById('register-password').value, confirmPassword = document.getElementById('register-confirm-password').value; if (password !== confirmPassword) { alert("Passwords do not match."); return; } try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); console.log("Registration successful:", userCredential.user); hideModals(); } catch (error) { alert(`Registration failed: ${error.message}`); } }
        async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value, rememberMe = document.getElementById('remember-me').checked; try { await setPersistence(auth, rememberMe ? browserLocalPersistence : browserSessionPersistence); const userCredential = await signInWithEmailAndPassword(auth, email, password); console.log("Login successful:", userCredential.user); hideModals(); } catch (error) { alert(`Login failed: ${error.message}`); } }
        async function handleForgotPassword(e) { e.preventDefault(); const email = document.getElementById('forgot-email').value; try { await sendPasswordResetEmail(auth, email); alert('Password reset email sent! Please check your inbox.'); hideModals(); } catch (error) { alert(`Failed to send reset email: ${error.message}`); } }
        async function handleGoogleSignIn() { try { const result = await signInWithPopup(auth, googleProvider); console.log("Google Sign-In successful:", result.user); hideModals(); } catch (error) { console.error("Google Sign-In failed:", error); alert(`Google Sign-In failed: ${error.message}`); } }
        async function handleGuestSignIn() { try { const userCredential = await signInAnonymously(auth); console.log("Signed in as guest:", userCredential.user); hideModals(); } catch (error) { console.error("Guest Sign-In failed:", error); alert(`Guest Sign-In failed: ${error.message}`); } }
        
        loginRegisterBtn.addEventListener('click', () => showModal(loginContent));
        logoutIcon.addEventListener('click', async () => { try { await signOut(auth); console.log("Logout successful."); } catch (error) { console.error("Logout failed:", error); } });

        // --- LEVEL 5: CONTENT & GAME LOGIC ---
        const contentLibrary = {
            javascript: {
                title: "Object-Oriented Programming",
                modules: [
                    {
                        title: "Intro to OOP", icon: "box",
                        quiz: {
                            questions: [
                                { type: 'multiple-choice', question: "What is an **object**?", options: ["A function that returns a value", "A blueprint for creating instances", "A collection of related data and functionality", "A primitive data type like a number"], answer: "A collection of related data and functionality", explanation: "An object is a self-contained unit that holds related data (properties) and functions (methods)." },
                                { type: 'code-correction', question: "This object is missing a method to calculate its area. Fix it.", code: "const rectangle = {\n  width: 10,\n  height: 5,\n};", answer: "const rectangle = {\n  width: 10,\n  height: 5,\n  getArea() { return this.width * this.height; }\n};", explanation: "A method is a function assigned to an object's property. The `this` keyword refers to the object itself." },
                                { type: 'multiple-choice', question: "What is a **class**?", options: ["A specific instance of an object", "A blueprint for creating objects", "A built-in data type", "A type of loop"], answer: "A blueprint for creating objects", explanation: "A class is a template for creating objects, providing an initial set of properties and methods." },
                                { type: 'fill-in-the-blank', question: "An **instance** of a class is also known as a `__`.", answer: "object", explanation: "When you create an object from a class, that object is an instance of that class.", flash: true, suggestions: ['method', 'prototype', 'object', 'blueprint'] },
                                { type: 'multiple-choice', question: "The `new` keyword is used to...", options: ["Create a new function", "Delete an object", "Create a new instance of a class", "Define a new class"], answer: "Create a new instance of a class", explanation: "The `new` keyword is used to instantiate a class, calling its constructor and creating a new object." },
                                { type: 'code-correction', question: "This class's constructor is missing something to assign its name property. Fix it.", code: "class Cat {\n  constructor(name) {\n    name = name;\n  }\n}", answer: "class Cat {\n  constructor(name) {\n    this.name = name;\n  }\n}", explanation: "The `this` keyword is used inside a class to refer to the instance being created." },
                                { type: 'drag-and-drop', question: "Match the term to its purpose.", items: [{ id: 'd1', text: 'Class' }, { id: 'd2', text: 'Object' }], targets: [{ id: 't1', text: 'A blueprint' }, { id: 't2', text: 'An instance' }], matches: { d1: 't1', d2: 't2' }, explanation: "The relationship between a class and an object is that of a blueprint to a specific building." },
                            ]
                        }
                    },
                    {
                        title: "Encapsulation & Abstraction", icon: "lock",
                        quiz: {
                            questions: [
                                { type: 'multiple-choice', question: "What is **encapsulation**?", options: ["The process of creating a new object", "Bundling data and methods into a single unit (an object)", "Hiding complex implementation details", "Creating a new class from an existing one"], answer: "Bundling data and methods into a single unit (an object)", explanation: "Encapsulation is about keeping related data and behavior together within an object." },
                                { type: 'code-correction', question: "Use a getter method to access the private `_balance` property.", code: "class BankAccount {\n  constructor(initial) { this._balance = initial; }\n}", answer: "class BankAccount {\n  constructor(initial) { this._balance = initial; }\n  getBalance() { return this._balance; }\n}", explanation: "A getter provides a controlled way to read a property's value, which is a core concept of encapsulation." },
                                { type: 'multiple-choice', question: "What is **abstraction**?", options: ["The process of breaking down a large program into smaller pieces", "The concept of hiding complex implementation details and showing only essential features", "The ability for an object to take on many forms", "The process of creating a new class"], answer: "The concept of hiding complex implementation details and showing only essential features", explanation: "Abstraction simplifies complex systems by providing a simple interface, hiding the inner workings." },
                                { type: 'fill-in-the-blank', question: "In JavaScript, a common convention for a private property is to use a `__` at the beginning of its name.", answer: "underscore", explanation: "While not truly private, a leading underscore (`_`) signals to other developers that the property is for internal use.", flash: true, suggestions: ['dash', 'underscore', 'dollar sign', 'hashtag'] },
                                { type: 'multiple-choice', question: "Which of these is a benefit of encapsulation?", options: ["It makes functions call themselves", "It makes code harder to read", "It reduces code coupling and improves maintainability", "It allows for multiple objects to be created from one class"], answer: "It reduces code coupling and improves maintainability", explanation: "By keeping data and methods together, changes to one object are less likely to break other parts of the application." },
                                { type: 'code-correction', question: "Fix this code to hide the `_secret` property, but allow external access via a method.", code: "class User {\n  constructor(name, secret) { this.name = name; this._secret = secret; }\n}", answer: "class User {\n  constructor(name, secret) { this.name = name; this._secret = secret; }\n  getSecret() { return this._secret; }\n}", explanation: "A getter method like `getSecret` allows controlled access to the internal `_secret` data, which is a form of abstraction." },
                                { type: 'drag-and-drop', question: "Match the principle to its main idea.", items: [{ id: 'd1', text: 'Encapsulation' }, { id: 'd2', text: 'Abstraction' }], targets: [{ id: 't1', text: 'Bundling related code and data' }, { id: 't2', text: 'Hiding complexity' }], matches: { d1: 't1', d2: 't2' }, explanation: "These two principles are often used together to create well-organized and easy-to-use code." },
                            ]
                        }
                    },
                    {
                        title: "Inheritance", icon: "git-branch",
                        quiz: {
                            questions: [
                                { type: 'multiple-choice', question: "What is **inheritance**?", options: ["The process of creating a new object", "The ability of a class to inherit properties and methods from another class", "A way to make a class private", "A mechanism for creating unique objects"], answer: "The ability of a class to inherit properties and methods from another class", explanation: "Inheritance allows you to create a new class (subclass) that reuses and extends the functionality of an existing class (superclass)." },
                                { type: 'code-correction', question: "The `Dog` class is not inheriting from `Animal`. Fix it.", code: "class Animal { constructor(name) { this.name = name; } }\nclass Dog { }", answer: "class Animal { constructor(name) { this.name = name; } }\nclass Dog extends Animal { }", explanation: "The `extends` keyword is used to set up a new class to inherit from a parent class." },
                                { type: 'multiple-choice', question: "What is the purpose of the `super()` keyword?", options: ["To call a method on the parent class", "To call the constructor of the parent class", "To access a parent's private methods", "To create a new class"], answer: "To call the constructor of the parent class", explanation: "In a subclass's constructor, `super()` must be called before using `this` to properly initialize the inherited properties." },
                                { type: 'fill-in-the-blank', question: "A class that inherits from another is called a `__`.", answer: "subclass", explanation: "A subclass is a child class that derives from a parent class, also known as a superclass.", flash: true, suggestions: ['parent', 'superclass', 'subclass', 'clone'] },
                                { type: 'multiple-choice', question: "Why is inheritance a key principle of OOP?", options: ["It prevents infinite loops", "It promotes code reuse and reduces redundancy", "It hides complex data", "It ensures that objects are unique"], answer: "It promotes code reuse and reduces redundancy", explanation: "By inheriting from a parent class, you can avoid rewriting common properties and methods." },
                                { type: 'code-correction', question: "This `Cat` class should call the `Animal` constructor. Fix it.", code: "class Animal { constructor(name) { this.name = name; } }\nclass Cat extends Animal { constructor(name) { this.name = name; } }", answer: "class Animal { constructor(name) { this.name = name; } }\nclass Cat extends Animal { constructor(name) { super(name); } }", explanation: "The `super()` call is required to initialize the `name` property that is defined in the parent class." },
                                { type: 'drag-and-drop', question: "Match the term to its role in an inheritance chain.", items: [{ id: 'd1', text: '`extends`' }, { id: 'd2', text: '`super`' }], targets: [{ id: 't1', text: 'Establishes the parent-child relationship' }, { id: 't2', text: 'Calls a method from the parent' }], matches: { d1: 't1', d2: 't2' }, explanation: "The `extends` keyword is a core part of the class syntax, while `super` is used for method calls within the inheritance chain." },
                            ]
                        }
                    },
                    {
                        title: "Polymorphism", icon: "shapes",
                        quiz: {
                            questions: [
                                { type: 'multiple-choice', question: "What is **polymorphism**?", options: ["The ability to create multiple objects from a single class", "The ability of a single function to operate on different data types or objects", "The process of hiding implementation details", "The ability to inherit from multiple classes"], answer: "The ability of a single function to operate on different data types or objects", explanation: "Polymorphism means 'many forms'. It allows methods to behave differently based on the object they are acting upon." },
                                { type: 'code-correction', question: "The `Dog`'s `makeSound` method should override the `Animal`'s. Fix it.", code: "class Animal { makeSound() { return 'Some sound'; } }\nclass Dog extends Animal { makeSound() { return 'Woof!'; } }", answer: "class Animal { makeSound() { return 'Some sound'; } }\nclass Dog extends Animal { makeSound() { return 'Woof!'; } }", explanation: "The code is already correct. This is a classic example of method overriding, a form of polymorphism." },
                                { type: 'multiple-choice', question: "Which of these is an example of polymorphism?", options: ["A function `add(a, b)` that works for both numbers and strings", "A class that can create multiple objects", "A function that can only be called once", "A method that is hidden from public access"], answer: "A function `add(a, b)` that works for both numbers and strings", explanation: "JavaScript's `+` operator is polymorphic. It can perform addition on numbers and concatenation on strings." },
                                { type: 'fill-in-the-blank', question: "When a subclass method redefines a parent class method, it is called `__`.", answer: "overriding", explanation: "Method overriding is a key aspect of polymorphism, allowing a subclass to provide a specific implementation of a method that is already defined in its parent class.", flash: true, suggestions: ['redefining', 'extending', 'overloading', 'overriding'] },
                                { type: 'multiple-choice', question: "What is the key benefit of polymorphism?", options: ["It makes code more rigid", "It allows for code to be more extensible and flexible", "It uses less memory", "It prevents objects from being created"], answer: "It allows for code to be more extensible and flexible", explanation: "Polymorphism allows you to write generic code that can work with a variety of objects, reducing the need for `if/else` checks on object types." },
                                { type: 'code-correction', question: "This function should be able to call the `speak` method on any object that has it. Fix it.", code: "function talk(animal) {\n  animal.speak();\n}", answer: "function talk(animal) {\n  if (typeof animal.speak === 'function') {\n    animal.speak();\n  }\n}", explanation: "This is a form of polymorphism. The `talk` function doesn't care what type of object `animal` is, as long as it has a `speak` method. The corrected code adds a safety check." },
                                { type: 'drag-and-drop', question: "Match the type of polymorphism to its description.", items: [{ id: 'd1', text: 'Overriding' }, { id: 'd2', text: 'Ad-hoc (e.g., operator overloading)' }], targets: [{ id: 't1', text: 'Subclass redefines a parent method' }, { id: 't2', text: 'A single function or operator works on different data types' }], matches: { d1: 't1', d2: 't2' }, explanation: "Polymorphism comes in various forms, from redefining methods in a class hierarchy to operators that work on different types." },
                            ]
                        }
                    },
                    {
                        title: "Advanced Concepts", icon: "box-select",
                        quiz: {
                            questions: [
                                { type: 'multiple-choice', question: "What is the **prototype chain** in JavaScript?", options: ["A list of all objects created from a class", "The chain of inheritance from one class to another", "A mechanism for objects to inherit properties from a `prototype` object", "A way to make an object a clone of another"], answer: "A mechanism for objects to inherit properties from a `prototype` object", explanation: "The prototype chain is the fundamental mechanism behind inheritance in JavaScript. Every object has a `prototype` property that points to its parent's prototype." },
                                { type: 'code-correction', question: "This object is missing a method to check if it's a specific instance. Fix it.", code: "const cat = new Cat();\ncat instanceof Animal;", answer: "const cat = new Cat();\ncat instanceof Cat;", explanation: "The `instanceof` operator is used to check if an object is an instance of a specific class." },
                                { type: 'multiple-choice', question: "What is the primary difference between a class and a constructor function in JavaScript?", options: ["There is no difference, they are just different syntax", "Classes can't have methods, but constructor functions can", "Classes are syntactical sugar over constructor functions and prototypes", "Constructor functions are a new feature in ES6"], answer: "Classes are syntactical sugar over constructor functions and prototypes", explanation: "The `class` syntax was introduced in ES6 to provide a cleaner, more familiar way to work with objects and inheritance, but it's built on top of the existing prototype-based inheritance model." },
                                { type: 'fill-in-the-blank', question: "A **static** method belongs to the `__`, not to an instance of the class.", answer: "class", explanation: "Static methods are utility functions that are relevant to the class as a whole, not to a specific object instance.", flash: true, suggestions: ['object', 'method', 'class', 'prototype'] },
                                { type: 'multiple-choice', question: "Which of the following describes a key advantage of OOP?", options: ["It forces code to be written in a linear fashion", "It simplifies complex software development by breaking it into manageable pieces", "It prevents you from using variables", "It makes your code less secure"], answer: "It simplifies complex software development by breaking it into manageable pieces", explanation: "OOP principles help in organizing code, which is essential for large, complex applications and collaborative projects." },
                                { type: 'code-correction', question: "Fix this to add a `create()` static method to the `Circle` class.", code: "class Circle {\n  constructor(radius) { this.radius = radius; }\n}\nCircle.create(5);", answer: "class Circle {\n  constructor(radius) { this.radius = radius; }\n  static create(radius) { return new Circle(radius); }\n}\nCircle.create(5);", explanation: "A static method is defined using the `static` keyword and can be called directly on the class itself." },
                                { type: 'drag-and-drop', question: "Match the term to its characteristic.", items: [{ id: 'd1', text: 'Prototype Chain' }, { id: 'd2', text: 'Static Method' }], targets: [{ id: 't1', text: 'Enables inheritance without `class` syntax' }, { id: 't2', text: 'Belongs to the class itself' }], matches: { d1: 't1', d2: 't2' }, explanation: "The prototype chain is the underlying mechanism, while static methods provide class-level functionality." },
                            ]
                        }
                    }
                ],
                finalExam: { 
                    title: "Final Exam (Lvl 5)", 
                    icon: "award", 
                    quiz: { 
                        questions: [
                            { type: 'multiple-choice', question: "What is the core principle of **polymorphism**?", options: ["Code reuse through inheritance", "Bundling data and methods together", "Methods behaving differently based on the object they're called on", "Hiding implementation details"], answer: "Methods behaving differently based on the object they're called on", explanation: "Polymorphism is the ability of an object to take on many forms, allowing a single method to work with different object types." },
                            { type: 'code-correction', question: "This subclass is incorrectly inheriting from the parent. Fix it.", code: "class Vehicle { move() { return 'Moving...'; } }\nclass Car { constructor() { super(); } move() { return 'Driving...'; } }", answer: "class Vehicle { move() { return 'Moving...'; } }\nclass Car extends Vehicle { constructor() { super(); } move() { return 'Driving...'; } }", explanation: "The `extends` keyword is necessary to establish the inheritance relationship between `Car` and `Vehicle`." },
                            { type: 'multiple-choice', question: "Which of the following is an example of **encapsulation**?", options: ["Using a loop to iterate through an array", "Creating a new class from an existing one", "Using a private method to perform an internal calculation", "Calling a function from within itself"], answer: "Using a private method to perform an internal calculation", explanation: "Encapsulation involves bundling data and behavior and controlling access to that data, often by using private methods or properties." },
                            { type: 'fill-in-the-blank', question: "A class is a `__` for creating objects.", answer: "blueprint", explanation: "The class provides the structure and behavior, while the object is a concrete instance based on that blueprint.", flash: true, suggestions: ['instance', 'blueprint', 'method', 'prototype'] },
                            { type: 'multiple-choice', question: "When a method in a subclass has the same name as a method in its superclass, it is called...", options: ["Method Hiding", "Method Extending", "Method Overloading", "Method Overriding"], answer: "Method Overriding", explanation: "Method overriding is when a subclass provides its own implementation of a method that is already defined by one of its superclasses." },
                            { type: 'code-correction', question: "Add a `getYear()` getter to this `Car` class to safely return the `_year` property.", code: "class Car {\n  constructor(year) { this._year = year; }\n}", answer: "class Car {\n  constructor(year) { this._year = year; }\n  getYear() { return this._year; }\n}", explanation: "A getter method is a common pattern in OOP to expose private data in a controlled way." },
                            { type: 'drag-and-drop', question: "Match the OOP principle to its purpose.", items: [{ id: 'd1', text: 'Inheritance' }, { id: 'd2', text: 'Abstraction' }], targets: [{ id: 't1', text: 'Code reuse' }, { id: 't2', text: 'Simplifying complexity' }], matches: { d1: 't1', d2: 't2' }, explanation: "Inheritance allows you to build on existing code, while abstraction allows you to hide complexity for a cleaner interface." },
                        ] 
                    } 
                }
            }
        };

        const SAVE_KEY = 'pathfinderSaveData_level5'; // Unique key for level 5
        const appState = {
            currentScreen: 'welcome',
            userName: '',
            learningPlan: null,
            quizState: null,
            achievements: new Set(),
            flashTimerInterval: null,
        };

        // --- NEW UNIFIED SAVE/LOAD LOGIC ---
        async function savePlayerState() {
            try {
                const stateToSave = {
                    ...appState,
                    achievements: [...appState.achievements], // Convert Set to Array for JSON
                };
                if (currentUser && !currentUser.isAnonymous) {
                    const userLevelRef = doc(db, "users", currentUser.uid, "levelProgress", "level5");
                    await setDoc(userLevelRef, stateToSave, { merge: true });
                    console.log("Level 5 progress saved to Firebase.");
                } else {
                    localStorage.setItem(SAVE_KEY, JSON.stringify(stateToSave));
                    console.log("Level 5 progress saved to Local Storage.");
                }
            } catch (e) {
                console.error("Failed to save state:", e);
            }
        }

        async function loadPlayerState() {
            try {
                let savedState = null;
                if (currentUser && !currentUser.isAnonymous) {
                    console.log("Attempting to load Level 5 progress from Firebase for user:", currentUser.uid);
                    const userLevelRef = doc(db, "users", currentUser.uid, "levelProgress", "level5");
                    const docSnap = await getDoc(userLevelRef);
                    if (docSnap.exists()) {
                        savedState = docSnap.data();
                        console.log("Level 5 progress loaded from Firebase.");
                    }
                } else {
                    const savedStateJSON = localStorage.getItem(SAVE_KEY);
                    if (savedStateJSON) {
                        savedState = JSON.parse(savedStateJSON);
                        console.log("Level 5 progress loaded from Local Storage.");
                    }
                }
                
                if (savedState) {
                    savedState.achievements = new Set(savedState.achievements); // Convert back to Set
                    return savedState;
                }
            } catch (e) {
                console.error("Failed to load or parse state:", e);
            }
            console.log("No saved state found for Level 5.");
            return null;
        }

        // --- Utils ---
        const shuffleArray = (array) => { return [...array].sort(() => Math.random() - 0.5); };
        const calculateLevel = (xp) => ({ level: Math.floor(xp / 100) + 1, nextLevelXp: (Math.floor(xp / 100) + 1) * 100 });
        function showXpAnimation() { const activityContainer = document.getElementById('activity-container'); if (!activityContainer) return; const xpEl = document.createElement('div'); xpEl.textContent = '+10 XP'; xpEl.className = 'xp-popup'; activityContainer.appendChild(xpEl); setTimeout(() => { xpEl.remove(); }, 1500); }

        // --- UI Navigation & Setup ---
        function navigateTo(screenName) {
            document.querySelectorAll('[data-screen]').forEach(screen => screen.classList.remove('active'));
            const newScreen = document.querySelector(`[data-screen="${screenName}"]`);
            if (newScreen) {
                newScreen.classList.add('active');
                newScreen.querySelector('.card, .p-4')?.classList.add('fade-in');
                appState.currentScreen = screenName;
            }
        }

        function startLearningPath() {
            appState.userName = currentUser?.displayName || "Learner";
            const planData = contentLibrary.javascript;
            appState.learningPlan = {
                ...planData,
                progress: planData.modules.reduce((acc, _, index) => ({ ...acc, [`module_${index}`]: 0 }), { finalExam: 0 }),
                xp: 0,
            };
            appState.achievements = new Set();
            savePlayerState();
            renderDashboard();
            navigateTo('dashboard');
        }
        
        // --- Dashboard and Activity Rendering ---
        function renderDashboard() {
            const { learningPlan } = appState;
            const userName = appState.userName || (currentUser?.displayName || "Learner");
            if (!learningPlan) return;
            const {level, nextLevelXp} = calculateLevel(learningPlan.xp);
            const topNav = document.getElementById('top-nav');

            topNav.innerHTML = `
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h1 class="text-2xl font-bold">Level 5: Object-Oriented Programming</h1>
                        <p class="text-gray-300">Welcome, ${userName}!</p>
                    </div>
                    <div id="achievements-bar" class="flex items-center gap-2">
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">Level ${level}</p>
                        <p class="text-xl font-bold text-teal-400">${learningPlan.xp} / ${nextLevelXp} XP</p>
                    </div>
                </div>
            `;

            renderProgressTracker();
            renderAchievements();
            showModuleList();
            lucide.createIcons();
        }

        function showModuleList() {
            if (appState.quizState && appState.quizState.timerId) clearInterval(appState.quizState.timerId);
            if (appState.flashTimerInterval) clearInterval(appState.flashTimerInterval);
            appState.quizState = null;
            
            const { modules, finalExam, progress } = appState.learningPlan;
             document.getElementById('activity-container').innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Level 5 Modules</h2>
                <div class="space-y-4">
                    ${modules.map((mod, i) => createModuleCard(mod, i)).join('')}
                    ${createModuleCard(finalExam, 'finalExam', true)}
                </div>
            `;
            
            if (progress.finalExam > 0) {
                 document.getElementById('activity-container').innerHTML += `
                    <div class="mt-8 text-center fade-in">
                        <h3 class="text-2xl font-bold text-teal-400">Level 5 Complete!</h3>
                        <p class="mt-2 text-gray-300">You've mastered OOP. The next challenge awaits.</p>
                        <a href="index6.html" class="btn mt-4">
                            <i data-lucide="arrow-right-circle" class="mr-2"></i>
                            Proceed to Level 6
                        </a>
                    </div>
                `;
            }

            document.getElementById('activity-container').classList.add('fade-in');
            lucide.createIcons();
        }

        function createModuleCard(module, index, isExam = false) {
             const progress = appState.learningPlan.progress;
             const id = isExam ? 'finalExam' : `module_${index}`;
             const isDone = progress[id] > 0;

            return `
            <div class="card module-card !p-4 flex items-center gap-4 cursor-pointer ${isDone ? 'bg-teal-500/20' : ''}" onclick="window.startActivity('${id}')">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center ${isExam ? 'bg-yellow-500' : 'bg-teal-500'} text-white flex-shrink-0">
                     <i data-lucide="${module.icon}"></i>
                </div>
                <div class="flex-grow">
                     <h3 class="text-xl font-bold">${module.title}</h3>
                     <p class="text-sm text-gray-400">${module.quiz.questions.length} Questions</p>
                </div>
                ${isDone ? '<i data-lucide="check-circle-2" class="w-8 h-8 text-teal-400"></i>' : '<i data-lucide="chevron-right" class="w-8 h-8 text-gray-400"></i>'}
            </div>
            `;
        }

        function renderProgressTracker() {
            const { progress, modules, finalExam } = appState.learningPlan;
            const tracker = document.getElementById('progress-tracker');
            
            const createTrackerItem = (id, icon, title, isDone) => `<div class="flex items-center gap-3 p-3 rounded-lg cursor-pointer hover:bg-white/10 ${isDone ? 'opacity-50' : ''}" onclick="${isDone ? '' : `window.startActivity('${id}')`}"><div class="w-8 h-8 rounded-full flex items-center justify-center ${isDone ? 'bg-teal-500' : 'bg-teal-500'} text-white"><i data-lucide="${isDone ? 'check' : icon}"></i></div><div><p class="font-semibold text-gray-200">${title}</p></div>${isDone ? '<i data-lucide="sparkles" class="w-5 h-5 text-yellow-400 ml-auto"></i>' : ''}</div>`;

            let html = modules.map((mod, i) => createTrackerItem(`module_${i}`, mod.icon, mod.title, progress[`module_${i}`] > 0)).join('');
            html += createTrackerItem('finalExam', finalExam.icon, finalExam.title, progress.finalExam > 0);
            tracker.innerHTML = html;
        }

        // --- Achievements ---
        const allAchievements = {
            oopRookie: { icon: 'box', title: 'OOP Rookie', description: 'Complete your first OOP module.' },
            classMaster: { icon: 'star', title: 'Class Master', description: 'Get a perfect score on a Level 5 module.' },
            oopPro: { icon: 'box-select', title: 'OOP Pro', description: 'Complete the entire OOP path.' }
        };

        function awardAchievement(id) {
            if (appState.achievements.has(id)) return;
            appState.achievements.add(id);
            const achievement = allAchievements[id];
            
            const modal = document.getElementById('achievement-modal');
            document.getElementById('modal-content-inner').innerHTML = `<i data-lucide="award" class="w-16 h-16 mx-auto text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold">Achievement Unlocked!</h2><p class="mt-2 font-semibold text-gray-200">${achievement.title}</p><p class="text-sm text-gray-300">${achievement.description}</p><button class="btn mt-6" onclick="this.closest('.modal-overlay').classList.remove('visible')">Continue</button>`;
            lucide.createIcons();
            modal.classList.add('visible');
            renderAchievements();
            savePlayerState();
        }

        function renderAchievements() {
            const barEl = document.getElementById('achievements-bar');
            if (!barEl) return; 

            let html = '<h3 class="text-lg font-bold mr-2 text-gray-300 hidden md:block">Achievements</h3>';
            
            for (const id in allAchievements) {
                const achievement = allAchievements[id];
                const isEarned = appState.achievements.has(id);
                
                html += `
                    <div class="achievement-icon ${isEarned ? '' : 'opacity-30'}" title="${achievement.title}">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${isEarned ? 'bg-yellow-400' : 'bg-gray-500'} text-white">
                            <i data-lucide="${achievement.icon}"></i>
                        </div>
                        <div class="tooltip">
                            <span class="tooltip-title">${achievement.title}</span>
                            <span class="tooltip-desc">${achievement.description}</span>
                        </div>
                    </div>
                `;
            }
            
            barEl.innerHTML = html;
            lucide.createIcons();
        }
        
        window.markComplete = (activityId, score) => {
            if (appState.quizState && appState.quizState.timerId) clearInterval(appState.quizState.timerId);
            if (appState.flashTimerInterval) clearInterval(appState.flashTimerInterval);

            const oldXp = appState.learningPlan.xp;
            const newXp = oldXp - (appState.learningPlan.progress[activityId] || 0) + score * 10;
            appState.learningPlan.progress[activityId] = score * 10;
            appState.learningPlan.xp = newXp;

            if (activityId !== 'finalExam') awardAchievement('oopRookie');
            const module = activityId === 'finalExam' ? appState.learningPlan.finalExam : appState.learningPlan.modules[activityId.split('_')[1]];
            if (score === module.quiz.questions.length) awardAchievement('classMaster');
            const allDone = appState.learningPlan.modules.every((_, i) => appState.learningPlan.progress[`module_${i}`] > 0) && appState.learningPlan.progress.finalExam > 0;
            if(allDone) awardAchievement('oopPro');

            renderDashboard();
            savePlayerState();
        }
        
        // --- Quiz Logic ---
        window.startActivity = (activityId) => {
            if (appState.quizState && appState.quizState.timerId) {
                clearInterval(appState.quizState.timerId);
                appState.quizState.timerId = null;
            }

            const isExam = activityId === 'finalExam';
            const moduleData = isExam ? appState.learningPlan.finalExam : appState.learningPlan.modules[activityId.split('_')[1]];
            appState.quizState = { activityId, questions: shuffleArray(moduleData.quiz.questions), currentIndex: 0, score: 0, timerId: null, timeLeft: moduleData.quiz.questions.length * 30 };
            appState.quizState.timerId = setInterval(updateTimer, 1000);
            renderQuizActivityQuestion();
        }
        function updateTimer() {
            if (!appState.quizState) return;
            appState.quizState.timeLeft--;
            const timerEl = document.getElementById('quiz-timer');
            if (timerEl) {
                const minutes = Math.floor(appState.quizState.timeLeft / 60);
                const seconds = appState.quizState.timeLeft % 60;
                const formattedSeconds = seconds.toString().padStart(2, '0');
                timerEl.textContent = `${minutes}:${formattedSeconds}`;
            }
            if (appState.quizState.timeLeft <= 0) {
                finishQuiz(true);
            }
        }
        function finishQuiz(timesUp = false) { if (!appState.quizState) return; if (appState.quizState.timerId) clearInterval(appState.quizState.timerId); if (appState.flashTimerInterval) clearInterval(appState.flashTimerInterval); const activityContainer = document.getElementById('activity-container'); activityContainer.innerHTML = `<div class="text-center fade-in"><h2 class="text-2xl font-bold">${timesUp ? "Time's Up!" : "Module Complete!"}</h2><p class="text-lg mt-2 text-gray-300">You scored</p><p class="text-5xl font-bold text-teal-400 my-4">${appState.quizState.score} / ${appState.quizState.questions.length}</p><button onclick="window.markComplete('${appState.quizState.activityId}', ${appState.quizState.score})" class="btn">Continue</button></div>`; }
        function renderQuizActivityQuestion() { if (appState.flashTimerInterval) clearInterval(appState.flashTimerInterval); const { quizState } = appState; if (!quizState) return; const quizData = quizState.questions[quizState.currentIndex]; const activityContainer = document.getElementById('activity-container'); let questionHTML = '', flashHeaderHTML = ''; if (quizData.flash) { flashHeaderHTML = `<div class="mb-4 p-3 rounded-lg bg-yellow-400/20 border border-yellow-400/30 flex items-center justify-center gap-4"><i data-lucide="zap" class="text-yellow-400 flash-indicator"></i><span class="font-semibold text-yellow-200">Flash Question!</span><span id="flash-timer" class="font-bold text-yellow-300 text-lg">15s</span></div>`; } if (quizData.type === 'multiple-choice') quizData.options = shuffleArray(quizData.options); switch(quizData.type) { case 'fill-in-the-blank': { let sHTML = ''; if (quizData.suggestions) { sHTML = `<datalist id="suggestions-list">${quizData.suggestions.map(s => `<option value="${s}"></option>`).join('')}</datalist>`; } const iHTML = `<input type="text" id="fill-in-blank-input" placeholder="Type or select an option" ${quizData.suggestions ? 'list="suggestions-list"' : ''} class="mx-2 p-1 border-b-2 border-teal-400 focus:outline-none focus:border-teal-500 bg-transparent text-white">`; questionHTML = `<p class="text-lg mb-6">${quizData.question.replace('______', iHTML).replace('____', iHTML)}</p>${sHTML}<button id="submit-fill-btn" class="btn">Submit</button>`; break; } case 'drag-and-drop': { questionHTML = `<p class="text-lg mb-6">${quizData.question}</p><div class="flex flex-col md:flex-row gap-8"><div class="w-full md:w-1/2 space-y-3"><h4 class="font-semibold">Items</h4>${quizData.items.map(item => `<div id="${item.id}" draggable="true" class="drag-item p-3 rounded-lg">${item.text}</div>`).join('')}</div><div class="w-full md:w-1/2 space-y-3"><h4 class="font-semibold">Targets</h4>${quizData.targets.map(target => `<div id="${target.id}" class="drop-target p-3 rounded-lg min-h-[50px]">${target.text}</div>`).join('')}</div></div><button id="submit-drag-btn" class="btn mt-6">Check Answer</button>`; break; } case 'code-correction': { questionHTML = `<p class="text-lg mb-4">${quizData.question}</p><pre class="bg-black/20 p-4 rounded-lg text-gray-400 text-sm mb-4"><code>${quizData.code}</code></pre><textarea id="code-correction-input" rows="3" class="w-full p-2 rounded-lg themed-input" placeholder="Enter corrected code here..."></textarea><button id="submit-code-btn" class="btn mt-4">Submit</button>`; break; } case 'multiple-choice': default: { questionHTML = `<p class="text-lg mb-6">${quizData.question}</p><div class="space-y-3">${quizData.options.map(opt => `<button class="w-full text-left p-4 rounded-lg quiz-act-option border-2 border-transparent hover:border-teal-400 bg-white/5 transition-colors" data-answer="${opt}">${opt}</button>`).join('')}</div>`; break; } } activityContainer.innerHTML = `<div class="fade-in"><div class="flex justify-between items-center mb-4"><button onclick="showModuleList()" class="text-sm text-teal-300 hover:text-teal-200">&larr; Back to Modules</button><div class="text-lg font-bold text-gray-300" id="quiz-timer"></div></div>${flashHeaderHTML}<h2 class="text-2xl font-bold mb-6">${quizState.questions[quizState.currentIndex].title || 'Question '+(quizState.currentIndex+1)}</h2><div id="question-content">${questionHTML}</div><div id="quiz-feedback-container" class="mt-6"></div></div>`; if (quizData.flash) { let t = 15; const ft = document.getElementById('flash-timer'); ft.textContent = `${t}s`; appState.flashTimerInterval = setInterval(() => { t--; ft.textContent = `${t}s`; if (t <= 0) { clearInterval(appState.flashTimerInterval); handleAnswer('__timeout__', quizData); } }, 1000); } setupQuestionEventListeners(quizData); lucide.createIcons(); }
        function setupQuestionEventListeners(quizData) { switch(quizData.type) { case 'multiple-choice': document.querySelectorAll('.quiz-act-option').forEach(btn => btn.addEventListener('click', (e) => handleAnswer(e.target.dataset.answer, quizData))); break; case 'fill-in-the-blank': document.getElementById('submit-fill-btn').addEventListener('click', () => handleAnswer(document.getElementById('fill-in-blank-input').value, quizData)); document.getElementById('fill-in-blank-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('submit-fill-btn').click(); }); break; case 'drag-and-drop': let dId = null; document.querySelectorAll('.drag-item').forEach(i => i.addEventListener('dragstart', e => { dId = e.target.id; e.dataTransfer.setData('text/plain', e.target.id); })); document.querySelectorAll('.drop-target').forEach(t => { t.addEventListener('dragover', e => { e.preventDefault(); t.classList.add('drag-over'); }); t.addEventListener('dragleave', () => t.classList.remove('drag-over')); t.addEventListener('drop', e => { e.preventDefault(); t.classList.remove('drag-over'); const dItem = document.getElementById(dId); if (dItem && t.children.length === 0) { t.appendChild(dItem); dItem.style.cursor = 'default'; }}); }); document.getElementById('submit-drag-btn').addEventListener('click', () => { let isCorrect = Object.entries(quizData.matches).every(([iId, tId]) => document.getElementById(tId).querySelector(`#${iId}`)); handleAnswer(isCorrect, quizData); }); break; case 'code-correction': document.getElementById('submit-code-btn').addEventListener('click', () => handleAnswer(document.getElementById('code-correction-input').value, quizData)); break; } }
        function handleAnswer(selectedAnswer, quizData) { if (appState.flashTimerInterval) clearInterval(appState.flashTimerInterval); const { quizState } = appState; let isCorrect = false, wasTimeout = selectedAnswer === '__timeout__'; if (!wasTimeout) { if (quizData.type === 'code-correction') { isCorrect = selectedAnswer.trim() === quizData.answer.trim(); } else if (typeof selectedAnswer === 'string') { isCorrect = selectedAnswer.trim().toLowerCase() === quizData.answer.trim().toLowerCase(); } else { isCorrect = selectedAnswer === true; } } if (isCorrect) { quizState.score++; showXpAnimation(); } const isLastQuestion = quizState.currentIndex === quizState.questions.length - 1; const feedbackContainer = document.getElementById('quiz-feedback-container'); let feedbackTitle = 'Correct!'; if (wasTimeout) feedbackTitle = "Time's Up!"; else if (!isCorrect) feedbackTitle = 'Not quite.'; feedbackContainer.innerHTML = `<div class="fade-in p-4 rounded-lg ${isCorrect ? 'bg-teal-500/20' : 'bg-red-500/20'}"><p class="font-semibold ${isCorrect ? 'text-teal-300' : 'text-red-300'}">${feedbackTitle}</p><p class="mt-2 text-sm ${isCorrect ? 'text-teal-400' : 'text-red-400'}">${quizData.explanation}</p></div><button id="next-quiz-btn" class="btn mt-4">${isLastQuestion ? 'Finish Quiz' : 'Next Question'}</button>`; document.querySelectorAll('button, input, textarea').forEach(el => { if(el.id !== 'next-quiz-btn') el.disabled = true; }); document.getElementById('next-quiz-btn').addEventListener('click', () => { if (isLastQuestion) finishQuiz(); else { quizState.currentIndex++; renderQuizActivityQuestion(); } }); }
        
        // --- APP INITIALIZATION ---
        async function initializePathfinderApp() {
            const loadedState = await loadPlayerState();
            if (loadedState && loadedState.learningPlan) {
                Object.assign(appState, loadedState);
                renderDashboard();
                navigateTo('dashboard');
            } else {
                navigateTo('welcome');
            }
            document.getElementById('start-learning-btn').addEventListener('click', startLearningPath);
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                console.log("User is logged in:", user.displayName || user.email);
                userDisplayName.textContent = user.displayName || user.email || `Guest-${user.uid.substring(0,5)}`;
                userProfileBtn.classList.remove('hidden');
                loginRegisterBtn.classList.add('hidden');
            } else {
                console.log("User is logged out.");
                userProfileBtn.classList.add('hidden');
                loginRegisterBtn.classList.remove('hidden');
            }
            // Initialize or re-initialize the app with the current user state
            initializePathfinderApp();
        });
        
    </script>
</body>
</html>
